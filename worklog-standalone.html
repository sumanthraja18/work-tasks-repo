<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Worklog Dashboard — Standalone</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#475569;--border:#e3e8ef;--accent:#2563eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    h1{margin:0 0 10px 0;font-size:24px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font:inherit;background:#fff}
    textarea{resize:vertical}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi .value{font-weight:700;font-size:24px}
    .list{display:grid;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .tag{background:#eef2ff;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
    .muted{color:var(--muted)}
    canvas{width:100%;max-width:100%;background:#fff;border:1px solid var(--border);border-radius:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f5f9;border:1px solid var(--border);font-size:12px}
    @media (max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr));}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h1>Daily Worklog & Follow-ups (Standalone)</h1>
      <div class="toolbar">
        <span id="cloudStatus" class="muted">Cloud: Not connected</span>
        <button id="connectCloud">Connect OneDrive File</button>
        <button id="syncNow" class="hidden">Sync now</button>
        <button id="disconnectCloud" class="hidden">Disconnect</button>
      </div>
    </div>

    <div class="row card" style="margin-top:8px">
      <div style="flex:1 1 160px">
        <label for="date">Date</label>
        <input id="date" type="date">
      </div>
      <div style="flex:3 1 260px">
        <label for="title">Title</label>
        <input id="title" placeholder="What did you work on?">
      </div>
      <div style="flex:1 1 160px">
        <label for="duration">Duration (minutes)</label>
        <input id="duration" type="number" min="0">
      </div>
      <div style="flex:1 1 200px">
        <label for="tags">Tags (comma separated)</label>
        <input id="tags" placeholder="sepsis, etl">
      </div>
      <div style="flex:1 1 160px">
        <label for="status">Status</label>
        <select id="status">
          <option value="in_progress">In Progress</option>
          <option value="done">Done</option>
          <option value="blocked">Blocked</option>
        </select>
      </div>
      <div style="flex:1 1 220px">
        <label><input id="createFU" type="checkbox"> Create follow-up</label>
        <div id="fuBox" class="hidden" style="margin-top:6px;border:1px dashed var(--border);border-radius:10px;padding:8px">
          <input id="fuTitle" placeholder="Follow-up title (optional)" style="margin-bottom:6px">
          <label for="fuDue" style="margin-top:4px">Due date (optional)</label>
          <input id="fuDue" type="date">
        </div>
      </div>
      <div style="flex:1 1 100%;display:flex;justify-content:flex-end;gap:8px">
        <button id="add" class="primary">Add Activity</button>
        <button id="backup">Backup (JSON)</button>
        <label class="badge" style="cursor:pointer">Restore (JSON) <input id="restore" type="file" accept="application/json" style="display:none"></label>
        <button id="exportCsv">Export CSV</button>
        <button id="reset">Reset</button>
      </div>
    </div>

    <div class="kpis" style="margin:12px 0">
      <div class="card kpi"><div class="muted">Total Hours</div><div id="kpiHours" class="value">0</div></div>
      <div class="card kpi"><div class="muted">Activities</div><div id="kpiCount" class="value">0</div></div>
      <div class="card kpi"><div class="muted">Done</div><div id="kpiDone" class="value">0</div></div>
      <div class="card kpi"><div class="muted">Open FUs</div><div id="kpiFU" class="value">0</div></div>
    </div>

    <div class="row" style="gap:12px">
      <div class="card" style="flex:1 1 48%">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="muted">Hours by Day</div>
          <div>
            <select id="range">
              <option value="last7">Last 7 days</option>
              <option value="last30">Last 30 days</option>
              <option value="week">This week</option>
              <option value="month">This month</option>
              <option value="today">Today</option>
            </select>
          </div>
        </div>
        <canvas id="byDay" height="220"></canvas>
      </div>
      <div class="card" style="flex:1 1 48%">
        <div class="muted">Hours by Tag</div>
        <canvas id="byTag" height="220"></canvas>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="card" style="flex:1 1 100%">
        <div class="muted">Cumulative Tasks</div>
        <canvas id="cumul" height="240"></canvas>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="card" style="flex:1 1 55%">
        <h3 style="margin:0 0 8px 0">Activities</h3>
        <div id="list" class="list"></div>
      </div>
      <div class="card" style="flex:1 1 45%">
        <h3 style="margin:0 0 8px 0">Follow-ups</h3>
        <div><strong>Open</strong></div>
        <div id="fuOpen" class="list" style="margin:6px 0 12px 0"></div>
        <div><strong>Completed</strong></div>
        <div id="fuDone" class="list" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="muted">Tips: This file is fully standalone (no Internet or CDNs required). For cloud sync, use “Connect OneDrive File” (works best in Edge/Chrome over HTTPS). If blocked by IT, you can still use local storage + Backup/Restore.</div>
    </div>
  </div>

  <script>
  // ---------- Utilities & Persistence ----------
  const $ = id => document.getElementById(id);
  const KEY="worklog_followups_store_v1";
  const todayISO = () => new Date().toISOString().slice(0,10);
  const parseTags = s => (s||"").split(",").map(t=>t.trim()).filter(Boolean).map(t=>t.toLowerCase());
  const hours = m => Math.round((m/60)*100)/100;

  function load(){ try{ const raw=localStorage.getItem(KEY); return raw?JSON.parse(raw):{activities:[],followUps:[]} } catch{ return {activities:[],followUps:[]} } }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
  function csvExport(filename, rows){
    if(!rows.length) return;
    const headers = Object.keys(rows[0]);
    const csv = [headers.join(",")].concat(rows.map(r=>headers.map(h=>JSON.stringify(r[h]??"")).join(","))).join("\n");
    const blob = new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }
  function downloadJSON(filename, obj){
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  // ---------- Simple date ranges ----------
  const startOfDay = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };
  function rangeObj(key){
    const now=new Date();
    if(key==="today") return {start:startOfDay(now), end:startOfDay(now)};
    if(key==="week"){ const s=new Date(now); s.setDate(now.getDate()-now.getDay()); const e=new Date(s); e.setDate(s.getDate()+6); return {start:startOfDay(s), end:startOfDay(e)}; }
    if(key==="month"){ const s=new Date(now.getFullYear(), now.getMonth(),1); const e=new Date(now.getFullYear(), now.getMonth()+1,0); return {start:startOfDay(s), end:startOfDay(e)}; }
    const n = (key==="last30") ? 30 : 7;
    const end=startOfDay(now); const start=new Date(end); start.setDate(end.getDate()-(n-1)); return {start, end};
  }
  const within = (iso, r) => { const d=startOfDay(new Date(iso)); return d>=startOfDay(r.start) && d<=startOfDay(r.end); };

  // ---------- App State ----------
  let store = load();
  $("date").value = todayISO();
  $("createFU").addEventListener("change", e => $("fuBox").classList.toggle("hidden", !e.target.checked));

  $("add").addEventListener("click", ()=>{
    const title = $("title").value.trim(); if(!title){ alert("Please enter a title"); return; }
    const act = {
      id: "act_"+Math.random().toString(36).slice(2,9)+"_"+Date.now().toString(36),
      date: $("date").value || todayISO(),
      title,
      details: $("details")?.value?.trim() || undefined,
      durationMinutes: $("duration").value ? Number($("duration").value) : 0,
      tags: parseTags($("tags").value),
      status: $("status").value,
      followUp: $("createFU").checked
    };
    if (act.followUp){
      const f = {
        id: "fu_"+Math.random().toString(36).slice(2,9)+"_"+Date.now().toString(36),
        createdAt: todayISO(),
        dueDate: $("fuDue").value || undefined,
        title: $("fuTitle").value || act.title,
        notes: act.details,
        tags: act.tags,
        status: "open"
      };
      act.followUpId = f.id;
      store.followUps = [f, ...store.followUps];
    }
    store.activities = [act, ...store.activities];
    save(store);
    $("title").value=""; $("details").value=""; $("duration").value=""; $("tags").value=""; $("status").value="in_progress";
    $("createFU").checked=false; $("fuBox").classList.add("hidden"); $("fuTitle").value=""; $("fuDue").value="";
    renderAll(); autoCloudSave();
  });

  $("reset").addEventListener("click", ()=>{
    if(!confirm("Erase all local data?")) return;
    store={activities:[], followUps:[]}; save(store); renderAll(); autoCloudSave();
  });

  $("backup").addEventListener("click", ()=> downloadJSON(`worklog_backup_${todayISO()}.json`, store));
  $("restore").addEventListener("change", async e=>{
    const file=e.target.files?.[0]; if(!file) return;
    try{
      const txt = await file.text(); const obj = JSON.parse(txt);
      if (!Array.isArray(obj.activities) || !Array.isArray(obj.followUps)) throw new Error("JSON must have activities[] and followUps[]");
      if (!confirm("Replace your current data with this backup?")) return;
      store = obj; save(store); renderAll(); autoCloudSave();
    } catch(err){ alert("Restore failed: " + err.message); }
    finally { e.target.value=""; }
  });

  $("exportCsv").addEventListener("click", ()=>{
    const acts = store.activities.map(a=>({id:a.id,date:a.date,title:a.title,details:a.details||"",durationMinutes:a.durationMinutes||0,tags:(a.tags||[]).join("|"),status:a.status,followUpId:a.followUpId||""}));
    const fus = store.followUps.map(f=>({id:f.id,createdAt:f.createdAt,dueDate:f.dueDate||"",title:f.title,notes:f.notes||"",tags:(f.tags||[]).join("|"),status:f.status}));
    const t = todayISO(); csvExport(`activities_${t}.csv`, acts); csvExport(`followups_${t}.csv`, fus);
  });

  $("range").addEventListener("change", renderAll);

  // ---------- Rendering ----------
  function renderAll(){
    const r = rangeObj($("range").value);
    const acts = store.activities.filter(a=>within(a.date, r)).sort((a,b)=>a.date.localeCompare(b.date));
    $("kpiCount").textContent = acts.length;
    $("kpiDone").textContent = acts.filter(a=>a.status==="done").length;
    $("kpiFU").textContent = store.followUps.filter(f=>f.status!=="done").length;
    $("kpiHours").textContent = hours(acts.reduce((s,a)=>s+(a.durationMinutes||0),0));

    // list
    const list = $("list"); list.innerHTML="";
    if(!acts.length){ list.innerHTML="<div class='muted'>No entries for this range.</div>"; }
    acts.forEach(a=>{
      const div=document.createElement("div"); div.className="item";
      div.innerHTML = `
        <div>
          <div><strong>${a.title}</strong> <span class="muted">(${new Date(a.date).toLocaleDateString()})</span></div>
          ${a.details?`<div class="muted">${a.details}</div>`:""}
          <div style="margin-top:6px">
            ${a.durationMinutes?`<span class="tag">${hours(a.durationMinutes)} h</span>`:""}
            <span class="tag">${a.status.replace("_"," ")}</span>
            ${(a.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join("")}
          </div>
        </div>
        <div><button class="del" title="Delete">🗑️</button></div>`;
      div.querySelector(".del").addEventListener("click", ()=>{
        if(!confirm("Delete this activity?")) return;
        store.activities = store.activities.filter(x=>x.id!==a.id); save(store); renderAll(); autoCloudSave();
      });
      list.appendChild(div);
    });

    // follow-ups
    const openRoot=$("fuOpen"), doneRoot=$("fuDone"); openRoot.innerHTML=""; doneRoot.innerHTML="";
    const makeFU = (f) => {
      const wrap=document.createElement("div"); wrap.className="item";
      wrap.innerHTML = `
        <div>
          <div><strong>${f.title}</strong> <span class="muted">${f.dueDate?("Due "+new Date(f.dueDate).toLocaleDateString()):"No due date"}</span></div>
          ${f.notes?`<div class="muted">${f.notes}</div>`:""}
          <div style="margin-top:6px">${(f.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join("")}</div>
        </div>
        <div>
          <select class="status">
            <option value="open" ${f.status==="open"?"selected":""}>Open</option>
            <option value="in_progress" ${f.status==="in_progress"?"selected":""}>In Progress</option>
            <option value="done" ${f.status==="done"?"selected":""}>Done</option>
          </select>
          <button class="rm" title="Remove">🗑️</button>
        </div>`;
      wrap.querySelector(".status").addEventListener("change", e=>{
        store.followUps = store.followUps.map(x=>x.id===f.id?{...x, status:e.target.value}:x); save(store); renderAll(); autoCloudSave();
      });
      wrap.querySelector(".rm").addEventListener("click", ()=>{
        if(!confirm("Remove this follow-up?")) return;
        store.followUps = store.followUps.filter(x=>x.id!==f.id); save(store); renderAll(); autoCloudSave();
      });
      return wrap;
    };
    const open = store.followUps.filter(f=>f.status!=="done");
    const done = store.followUps.filter(f=>f.status==="done");
    if(!open.length) openRoot.innerHTML = "<div class='muted'>No open follow-ups.</div>"; else open.forEach(f=>openRoot.appendChild(makeFU(f)));
    if(!done.length) doneRoot.innerHTML = "<div class='muted'>No completed follow-ups.</div>"; else done.forEach(f=>doneRoot.appendChild(makeFU(f)));

    // charts
    drawByDay(acts);
    drawByTag(acts);
    drawCumul(acts);
  }

  // ---------- Tiny chart helpers (no libraries) ----------
  function clearCanvas(c){ const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); }
  function drawAxes(ctx, w, h, padding){ ctx.strokeStyle="#cbd5e1"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(padding, h-padding); ctx.lineTo(w-padding, h-padding); ctx.moveTo(padding, padding); ctx.lineTo(padding, h-padding); ctx.stroke(); }
  function niceMax(v){ if(v<=1) return 1; const p=Math.pow(10, Math.floor(Math.log10(v))); return Math.ceil(v/p)*p; }

  function drawByDay(acts){
    const c=$("byDay"), ctx=c.getContext("2d"), w=c.width=c.clientWidth*2, h=c.height=c.height*2/2; // keep visual height
    clearCanvas(c);
    const padding=50;
    const map={}; acts.forEach(a=>{ map[a.date]=(map[a.date]||0)+(a.durationMinutes||0); });
    const entries=Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0]));
    const labels=entries.map(e=>e[0]); const values=entries.map(e=>hours(e[1]));
    const maxV=niceMax(Math.max(1, ...values, 1));
    drawAxes(ctx,w,h,padding);
    const plotW=w-2*padding, plotH=h-2*padding;
    const bw = labels.length? plotW/labels.length*0.6 : 0;
    labels.forEach((lab,i)=>{
      const x = padding + (plotW/Math.max(1,labels.length))*(i+0.5);
      const val = values[i]; const y = h - padding - (val/maxV)*plotH;
      ctx.fillStyle="#93c5fd"; ctx.fillRect(x-bw/2, y, bw, h-padding - y);
      ctx.fillStyle="#334155"; ctx.font="20px system-ui"; ctx.textAlign="center";
      if(labels.length<=12){ ctx.fillText(new Date(lab).toLocaleDateString(undefined,{month:"numeric",day:"numeric"}), x, h-padding+24); }
    });
    // y labels
    ctx.fillStyle="#334155"; ctx.textAlign="right";
    for(let t=0;t<=4;t++){ const v=maxV*t/4; const y=h-padding-(v/maxV)*plotH; ctx.fillText(String(v), padding-8, y+6); }
  }

  function drawByTag(acts){
    const c=$("byTag"), ctx=c.getContext("2d"), w=c.width=c.clientWidth*2, h=c.height=c.height*2/2;
    clearCanvas(c);
    const map={}; acts.forEach(a=>(a.tags||[]).forEach(t=>{ map[t]=(map[t]||0)+(a.durationMinutes||0); }));
    const entries=Object.entries(map).sort((a,b)=>b[1]-a[1]); const labels=entries.map(e=>e[0]); const values=entries.map(e=>hours(e[1]));
    const total = values.reduce((s,v)=>s+v,0) || 1;
    const cx=w/2, cy=h/2, r=Math.min(w,h)/2 - 20;
    let start=0;
    labels.forEach((lab,i)=>{
      const frac = values[i]/total; const end = start + frac*2*Math.PI;
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle = `hsl(${(i*70)%360},70%,70%)`;
      ctx.arc(cx,cy, r, start, end); ctx.closePath(); ctx.fill();
      // label
      const mid=(start+end)/2; const lx=cx+Math.cos(mid)*(r*0.7), ly=cy+Math.sin(mid)*(r*0.7);
      if(values[i]>0){ ctx.fillStyle="#0f172a"; ctx.font="20px system-ui"; ctx.textAlign="center"; ctx.fillText(lab, lx, ly); }
      start=end;
    });
  }

  function drawCumul(acts){
    const c=$("cumul"), ctx=c.getContext("2d"), w=c.width=c.clientWidth*2, h=c.height=c.height*2/2;
    clearCanvas(c);
    const padding=50;
    const sorted=[...acts].sort((a,b)=>a.date.localeCompare(b.date));
    let cumAll=0, cumDone=0; const labels=[], A=[], D=[];
    sorted.forEach(a=>{ cumAll++; if(a.status==="done") cumDone++; labels.push(a.date); A.push(cumAll); D.push(cumDone); });
    const maxV=niceMax(Math.max(1, ...A, ...D, 1));
    drawAxes(ctx,w,h,padding);
    const plotW=w-2*padding, plotH=h-2*padding;
    function drawLine(vals,color){
      ctx.beginPath(); ctx.strokeStyle=color; ctx.lineWidth=3;
      vals.forEach((v,i)=>{
        const x = padding + (plotW/Math.max(1,labels.length-1))*(i);
        const y = h - padding - (v/maxV)*plotH;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }
    drawLine(A,"#1d4ed8"); drawLine(D,"#10b981");
    ctx.fillStyle="#334155"; ctx.textAlign="right";
    for(let t=0;t<=4;t++){ const v=maxV*t/4; const y=h-padding-(v/maxV)*plotH; ctx.fillText(String(v), padding-8, y+6); }
  }

  // ---------- Cloud sync via File System Access API (optional) ----------
  const CLOUD_KEY='cloudFileHandle';
  const cloud = { handle:null, connected:false, timer:null };
  const idb = {
    open(){ return new Promise((res,rej)=>{ const r=indexedDB.open('worklog-cloud-db',1); r.onupgradeneeded=()=>r.result.createObjectStore('handles'); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); },
    async set(k,v){ const db=await idb.open(); return new Promise((res,rej)=>{ const tx=db.transaction('handles','readwrite'); tx.objectStore('handles').put(v,k); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); },
    async get(k){ const db=await idb.open(); return new Promise((res,rej)=>{ const tx=db.transaction('handles','readonly'); const rq=tx.objectStore('handles').get(k); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error); }); },
    async del(k){ const db=await idb.open(); return new Promise((res,rej)=>{ const tx=db.transaction('handles','readwrite'); tx.objectStore('handles').delete(k); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); },
  };
  function updateCloudUI(){
    $("cloudStatus").textContent = "Cloud: " + (cloud.connected ? "Connected" : "Not connected");
    $("syncNow").classList.toggle("hidden", !cloud.connected);
    $("disconnectCloud").classList.toggle("hidden", !cloud.connected);
  }
  async function requestPerm(h,mode){ const p=await h.queryPermission({mode}); if(p==="granted") return true; if(p==="prompt"){ const r=await h.requestPermission({mode}); return r==="granted"; } return false; }
  async function cloudConnect(){
    if(!('showOpenFilePicker' in window)){ alert("Your browser does not allow file picking here. Try Edge/Chrome over HTTPS."); return; }
    try{
      const [h] = await window.showOpenFilePicker({ types:[{description:"JSON", accept:{"application/json":[".json"]}}], excludeAcceptAllOption:true, multiple:false });
      const ok = await requestPerm(h,'readwrite'); if(!ok){ alert("Permission denied."); return; }
      cloud.handle=h; await idb.set(CLOUD_KEY,h); cloud.connected=true; updateCloudUI();
      // Load from file (merge/replace)
      const f=await h.getFile(); if(f.size>0){ const text=await f.text(); try{ const obj=JSON.parse(text); if(obj.activities&&obj.followUps){ store=obj; save(store); } }catch{} }
      renderAll();
      autoCloudSave();
    }catch(e){ console.warn(e); }
  }
  async function cloudDisconnect(){ await idb.del(CLOUD_KEY); cloud.handle=null; cloud.connected=false; updateCloudUI(); }
  async function cloudSave(){
    if(!cloud.connected || !cloud.handle) return;
    const ok = await requestPerm(cloud.handle,'readwrite'); if(!ok) return;
    const w = await cloud.handle.createWritable(); await w.write(JSON.stringify(store,null,2)); await w.close();
  }
  function autoCloudSave(){ if(!cloud.connected) return; clearTimeout(cloud.timer); cloud.timer=setTimeout(cloudSave, 1000); }
  async function tryRestoreCloud(){
    try{ const h = await idb.get(CLOUD_KEY); if(!h) return; const ok=await requestPerm(h,'readwrite'); if(!ok) return; cloud.handle=h; cloud.connected=true; updateCloudUI(); }catch{}
  }

  $("connectCloud").addEventListener("click", cloudConnect);
  $("disconnectCloud").addEventListener("click", cloudDisconnect);
  $("syncNow").addEventListener("click", cloudSave);

  // ---------- Init ----------
  (async function(){
    await tryRestoreCloud();
    renderAll();
  })();
  </script>
</body>
</html>
