<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Worklog Dashboard ‚Äî Standalone</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#475569;--border:#e3e8ef;--accent:#2563eb}.hidden{display:none !important;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    h1{margin:0 0 10px 0;font-size:24px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font:inherit;background:#fff}
    textarea{resize:vertical}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi .value{font-weight:700;font-size:24px}
    .list{display:grid;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .tag{background:#eef2ff;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
    .muted{color:var(--muted)}
    canvas{width:100%;max-width:100%;background:#fff;border:1px solid var(--border);border-radius:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f5f9;border:1px solid var(--border);font-size:12px}
.file-btn{position:relative; display:inline-block}
.file-btn > input[type=file]{position:absolute; left:0; top:0; width:100%; height:100%; opacity:0; cursor:pointer}
    @media (max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr));}}
  
    .accordion-item{border:1px solid var(--border);border-radius:12px;background:#fff}
    .accordion-header{width:100%;display:flex;align-items:center;justify-content:space-between;gap:8px;background:transparent;border:none;padding:10px 12px;cursor:pointer;border-radius:12px}
    .accordion-header:focus{outline:2px solid var(--accent)}
    .accordion-title{display:flex;align-items:center;gap:8px;text-align:left}
    .caret{transition:transform .2s ease}
    .accordion-content{display:none;padding:0 12px 12px 12px;border-top:1px dashed var(--border)}
    .accordion-item.open .accordion-content{display:block}
    .accordion-item.open .caret{transform:rotate(90deg)}
    .toolbar-sm{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    
/* Follow-up header grid: title | status | edit | delete */
.fu-header{
  display:grid;
  grid-template-columns: 1fr 140px 40px 40px;
  align-items:center;
  gap:8px;
}
.fu-status{ width:140px; }
.fu-action{ width:40px; text-align:center; }
.fu-edit, .fu-del{ width:40px; padding:6px 0; }
.fu-edit{ border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer; }
.fu-del{ border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer; }
.fu-edit:hover, .fu-del:hover{ background:#f8fafc; }

/* Color-coding by status */
.accordion-item.fu-open, .item.fu-open{ border-left:6px solid #f59e0b; background:#fffbeb; }      /* Amber */
.accordion-item.fu-inprogress, .item.fu-inprogress{ border-left:6px solid #3b82f6; background:#eff6ff; } /* Blue */
.accordion-item.fu-done, .item.fu-done{ border-left:6px solid #10b981; background:#ecfdf5; }       /* Emerald */


/* --- Follow-up header layout & controls --- */
.accordion-header.fu-header{ display:grid !important; grid-template-columns: 1fr 160px 80px 80px; align-items:center; gap:8px; padding:10px 12px; }
.fu-status{ width:160px; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:#fff; }
.fu-action{ width:80px; text-align:center; }
.fu-btn{ width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer; }
.fu-btn:hover{ background:#f8fafc; }
/* Color-coding by status */
.accordion-item.fu-open{ border-left:6px solid #f59e0b; background:#fffbeb; }
.accordion-item.fu-inprogress{ border-left:6px solid #3b82f6; background:#eff6ff; }
.accordion-item.fu-done{ border-left:6px solid #10b981; background:#ecfdf5; }


/* Printable overlay fallback */
.print-overlay{position:fixed; inset:0; background:#fff; z-index:9999; overflow:auto; padding:24px}
.print-toolbar{display:flex; justify-content:flex-end; gap:8px; margin-bottom:12px}
@media print{
  .no-print, .wrap{ display:none !important; }
  .print-overlay{ position:static; inset:auto; padding:0; z-index:auto }
}

</style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h1>Daily Worklog & Follow-ups (Standalone)</h1>
      <div class="toolbar">
        <span id="cloudStatus" class="muted">Cloud: Not connected</span>
        <button id="connectCloud">Connect OneDrive File</button>
        <button id="syncNow" class="hidden">Sync now</button>
        <button id="disconnectCloud" class="hidden">Disconnect</button>
      </div>
    </div>

    <div class="row card" style="margin-top:8px">
      <div style="flex:1 1 160px">
        <label for="date">Date</label>
        <input id="date" type="date">
      </div>
      <div style="flex:3 1 260px">
        <label for="title">Title</label>
        <input id="title" placeholder="What did you work on?">
      </div>
      <div style="flex:1 1 160px">
        <label for="duration">Duration (minutes)</label>
        <input id="duration" type="number" min="0">
      </div>
      <div style="flex:1 1 200px">
        <label for="tags">Tags (comma separated)</label>
        <input id="tags" placeholder="sepsis, etl">
      </div>
      
      <div style="flex:1 1 220px">
        <label><input id="createFU" type="checkbox"> Create follow-up</label>
        <div id="fuBox" class="hidden" style="margin-top:6px;border:1px dashed var(--border);border-radius:10px;padding:8px"><input id="fuTitle" placeholder="Follow-up title (optional)" style="margin-bottom:6px"><label for="fuDue" style="margin-top:4px; display:block">Due date (optional)</label><input id="fuDue" type="date" style="margin-bottom:6px"><label for="fuNotes" style="margin-top:4px; display:block">Follow-up notes (optional)</label><textarea id="fuNotes" rows="3" placeholder="Additional context for this follow-up"></textarea></div>
      </div>
      <div style="flex:1 1 100%;display:flex;justify-content:flex-end;gap:8px">
        <button id="add" class="primary">Add Activity</button>
        <button id="backup">Backup (JSON)</button>
        <span class="file-btn"><button id="restoreBtn" type="button">Restore (JSON)</button><input id="restore" type="file" accept="application/json"></span>
        <button id="exportCsv">Export CSV</button>
        <button id="reset">Reset</button>
      </div>
    </div>

    <div class="row card" style="margin-top:12px">
      <div style="flex:2 1 260px">
        <label for="qfuTitle">Follow-up title</label>
        <input id="qfuTitle" placeholder="e.g., Close out BI dashboard scope with team">
      </div>
      <div style="flex:1 1 200px">
        <label for="qfuDue">Due date (optional)</label>
        <input id="qfuDue" type="date">
      </div>
      <div style="flex:1 1 200px">
        <label for="qfuTags">Tags (optional)</label>
        <input id="qfuTags" placeholder="sepsis, etl">
      </div>
      <div style="flex:1 1 160px">
        <label for="qfuStatus">Status</label>
        <select id="qfuStatus">
          <option value="open">Open</option>
          <option value="in_progress">In Progress</option>
          <option value="done">Done</option>
        </select>
      </div>
      <div style="flex:1 1 100%">
        <label for="qfuNotes">Follow-up notes (optional)</label>
        <textarea id="qfuNotes" rows="3" placeholder="Additional context"></textarea>
      </div>
      <div style="flex:1 1 100%; display:flex; justify-content:flex-end">
        <button id="qfuAdd" class="primary" type="button">Add Follow-up</button>
      </div>
    </div>


    <div class="kpis" style="margin:12px 0">
      <div class="card kpi"><div class="muted">Total Hours</div><div id="kpiHours" class="value">0</div></div>
      <div class="card kpi"><div class="muted">Activities</div><div id="kpiCount" class="value">0</div></div>
      <div class="card kpi"><div class="muted">Done</div><div id="kpiDone" class="value">0</div></div>
      <div class="card kpi"><div class="muted">Open FUs</div><div id="kpiFU" class="value">0</div></div>
    </div>

    
    <div class="card" style="margin-top:12px">
      <div class="row" style="align-items:center; justify-content:space-between; gap:8px">
        <div class="row" style="align-items:center; gap:8px">
          <span class="muted">Summary Range</span>
          <select id="range">
            <option value="last7">Last 7 days</option>
            <option value="last30">Last 30 days</option>
            <option value="week">This week</option>
            <option value="month">This month</option>
            <option value="today">Today</option>
            <option value="custom">Custom‚Ä¶</option>
          </select>
          <div id="customRange" class="hidden row" style="align-items:center; gap:6px">
            <label>From <input id="fromDate" type="date"></label>
            <label>To <input id="toDate" type="date"></label>
            <button id="applyCustom" type="button">Apply</button>
          </div>
        </div>
        <div class="row" style="align-items:center; gap:8px">
          <button id="exportSummaryCsv" type="button">Export Summary (CSV)</button>
          <div class="badge" style="display:flex; gap:6px; align-items:center">
            <label style="display:flex; gap:4px; align-items:center">
              <input id="autoBackupEnabled" type="checkbox"> Auto-backup daily at
            </label>
            <input id="autoBackupTime" type="time" value="17:00">
            <button id="runBackupNow" type="button">Backup Now</button>
          </div>
        </div>
      </div>
    </div>

    
<div class="card" style="margin-top:12px">
  <div class="row" style="align-items:center; justify-content:space-between; gap:8px">
    <div class="row" style="align-items:center; gap:8px">
      <span class="muted">Summary Actions</span>
    </div>
    <div class="row" style="align-items:center; gap:8px">
      <button id="openPrintableSummary" type="button">Open Printable Summary</button>
      <button id="exportSummaryCsv" type="button">Export Summary (CSV)</button>
    </div>
  </div>
</div>
<div class="row" style="gap:12px">
        
      <div class="card" style="flex:1 1 48%">
        <div class="muted">Hours by Day</div>
        <canvas id="byDay" height="220"></canvas>
      </div>
      <div class="card" style="flex:1 1 48%">
        <div class="muted">Hours by Tag</div>
        <canvas id="byTag" height="220"></canvas>
        <div id="legendByTag" class="row" style="margin-top:8px; flex-wrap:wrap; gap:6px"></div>
      </div>
    </div>
    

        <div class="row" style="margin-top:12px">
      <div class="card" style="flex:1 1 55%">
        <div class="row" style="justify-content:space-between;align-items:center;margin:0 0 8px 0"><h3 style="margin:0">Activities</h3><div class="toolbar-sm"><button id="toggleActivitiesSection" type="button">Hide section</button><button id="actsExpandAll" type="button">Expand all</button><button id="actsCollapseAll" type="button">Collapse all</button></div></div>
        <div id="activitiesSectionContent"><div id="list" class="list"></div></div>
      </div>
      <div class="card" style="flex:1 1 45%">
        <div class="row" style="justify-content:space-between;align-items:center;margin:0 0 8px 0"><h3 style="margin:0">Follow-ups</h3><div class="toolbar-sm"><button id="fuExpandAll" type="button">Expand all</button><button id="fuCollapseAll" type="button">Collapse all</button></div></div>
        <div><strong>Open</strong></div>
        <div id="fuOpen" class="list" style="margin:6px 0 12px 0"></div>
        <div><strong>Completed</strong></div>
        <div id="fuDone" class="list" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="muted">Tips: This file is fully standalone (no Internet or CDNs required). For cloud sync, use ‚ÄúConnect OneDrive File‚Äù (works best in Edge/Chrome over HTTPS). If blocked by IT, you can still use local storage + Backup/Restore.</div>
    </div>
  </div>

  <script>
  // ---------- Utilities & Persistence ----------
  const $ = id => document.getElementById(id);
  const KEY="worklog_followups_store_v1";
  const todayISO = () => {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
};
  const parseTags = s => (s||"").split(",").map(t=>t.trim()).filter(Boolean).map(t=>t.toLowerCase());
  const hours = m => Math.round((m/60)*100)/100;
  function fmtISO(iso){ if(!iso) return ''; const p=iso.split('-'); if(p.length!==3) return iso; return `${Number(p[1])}/${Number(p[2])}/${p[0]}`; }

  function load(){ try{ const raw=localStorage.getItem(KEY); return raw?JSON.parse(raw):{activities:[],followUps:[]} } catch{ return {activities:[],followUps:[]} } }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
  function csvExport(filename, rows){
    if(!rows.length) return;
    const headers = Object.keys(rows[0]);
    const csv = [headers.join(",")].concat(rows.map(r=>headers.map(h=>JSON.stringify(r[h]??"")).join(","))).join("\n");
    const blob = new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }
  
  // ====== Settings (auto-backup) ======
  const SETTINGS_KEY = "worklog_settings_v1";
  function loadSettings(){
    try{ const raw=localStorage.getItem(SETTINGS_KEY); return raw?JSON.parse(raw):{autoBackup:{enabled:false,time:"17:00",lastRun:""}}; }
    catch{ return {autoBackup:{enabled:false,time:"17:00",lastRun:""}}; }
  }
  function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
  let settings = loadSettings();
  (function initSettingsUI(){
    const enabledEl = document.getElementById("autoBackupEnabled");
    const timeEl = document.getElementById("autoBackupTime");
    if (enabledEl) enabledEl.checked = !!settings.autoBackup.enabled;
    if (timeEl && settings.autoBackup.time) timeEl.value = settings.autoBackup.time;
    enabledEl?.addEventListener("change", ()=>{ settings.autoBackup.enabled = enabledEl.checked; saveSettings(settings); });
    timeEl?.addEventListener("change", ()=>{ settings.autoBackup.time = timeEl.value || "17:00"; saveSettings(settings); });
    document.getElementById("runBackupNow")?.addEventListener("click", ()=>{
      downloadJSON(`worklog_backup_${todayISO()}.json`, store);
      const today = new Date().toISOString().slice(0,10);
      settings.autoBackup.lastRun = today; saveSettings(settings);
    });
    // minute-level scheduler (fires only if page is open)
    setInterval(()=>{
      if(!settings.autoBackup.enabled) return;
      const now = new Date();
      const [hh,mm] = (settings.autoBackup.time||"17:00").split(":").map(Number);
      const todayStr = now.toISOString().slice(0,10);
      const already = settings.autoBackup.lastRun === todayStr;
      if(!already && now.getHours()===hh && now.getMinutes()===mm){
        downloadJSON(`worklog_backup_${todayStr}.json`, store);
        settings.autoBackup.lastRun = todayStr; saveSettings(settings);
      }
    }, 60000);
  })();

  // ====== Custom date range handling ======
  const fromEl = document.getElementById("fromDate");
  const toEl = document.getElementById("toDate");
  const customWrap = document.getElementById("customRange");
  document.getElementById("range").addEventListener("change", (e)=>{
    const isCustom = e.target.value === "custom";
    customWrap?.classList.toggle("hidden", !isCustom);
    if(!isCustom) renderAll();
  });
  document.getElementById("applyCustom")?.addEventListener("click", ()=>{
    renderAll();
  });

  function getCurrentRange(){
    const key = document.getElementById("range").value;
    if(key !== "custom"){ return rangeObj(key); }
    const from = fromEl?.value ? new Date(fromEl.value) : null;
    const to = toEl?.value ? new Date(toEl.value) : null;
    if (!from && !to) return rangeObj("last7");
    const start = from ? new Date(from) : new Date("1970-01-01");
    const end = to ? new Date(to) : new Date();
    return { start, end };
  }

  // Replace renderAll's usage of rangeObj(range.value) with getCurrentRange()

  function downloadJSON(filename, obj){
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  // ---------- Simple date ranges ----------
  const startOfDay = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };
  function rangeObj(key){
    const now=new Date();
    if(key==="today") return {start:startOfDay(now), end:startOfDay(now)};
    if(key==="week"){ const s=new Date(now); s.setDate(now.getDate()-now.getDay()); const e=new Date(s); e.setDate(s.getDate()+6); return {start:startOfDay(s), end:startOfDay(e)}; }
    if(key==="month"){ const s=new Date(now.getFullYear(), now.getMonth(),1); const e=new Date(now.getFullYear(), now.getMonth()+1,0); return {start:startOfDay(s), end:startOfDay(e)}; }
    const n = (key==="last30") ? 30 : 7;
    const end=startOfDay(now); const start=new Date(end); start.setDate(end.getDate()-(n-1)); return {start, end};
  }
  const within = (iso, r) => {
  if(!iso) return false;
  const [y,m,d] = String(iso).split('-').map(Number);
  const local = new Date(y, (m||1)-1, d||1, 0,0,0,0);
  const sd = startOfDay(local);
  return sd>=startOfDay(r.start) && sd<=startOfDay(r.end);
};

  // ---------- App State ----------
  let store = load();
  $("date").value = todayISO();
  $("createFU").addEventListener("change", e => $("fuBox").classList.toggle("hidden", !e.target.checked));

  $("add").addEventListener("click", ()=>{
    const title = $("title").value.trim(); if(!title){ alert("Please enter a title"); return; }
    const act = {
      id: "act_"+Math.random().toString(36).slice(2,9)+"_"+Date.now().toString(36),
      date: $("date").value || todayISO(),
      title,
      details: $("details")?.value?.trim() || undefined,
      durationMinutes: $("duration").value ? Number($("duration").value) : 0,
      tags: parseTags($("tags").value),
      status: "done",
      followUp: $("createFU").checked
    };
    if (act.followUp){
      const f = {
        id: "fu_"+Math.random().toString(36).slice(2,9)+"_"+Date.now().toString(36),
        createdAt: todayISO(),
        dueDate: $("fuDue").value || undefined,
        title: $("fuTitle").value || act.title,
        notes: (document.getElementById("fuNotes")?.value || act.details),
        tags: act.tags,
        status: "open"
      };
      act.followUpId = f.id;
      store.followUps = [f, ...store.followUps];
    }
    store.activities = [act, ...store.activities];
    save(store);
    $("title").value=""; $("details").value=""; $("duration").value=""; $("tags").value=""; $("status").value="in_progress";
    $("createFU").checked=false; $("fuBox").classList.add("hidden"); $("fuTitle").value=""; $("fuDue").value=""; (document.getElementById("fuNotes")||{}).value="";
    renderAll(); autoCloudSave();
  });

  $("reset").addEventListener("click", ()=>{
    if(!confirm("Erase all local data?")) return;
    store={activities:[], followUps:[]}; save(store); renderAll(); autoCloudSave();
  });

  $("backup").addEventListener("click", ()=> downloadJSON(`worklog_backup_${todayISO()}.json`, store));
  $("restore").addEventListener("change", async e=>{
    const file=e.target.files?.[0]; if(!file) return;
    try{
      const txt = await file.text(); const obj = JSON.parse(txt);
      if (!Array.isArray(obj.activities) || !Array.isArray(obj.followUps)) throw new Error("JSON must have activities[] and followUps[]");
      if (!confirm("Replace your current data with this backup?")) return;
      store = obj; save(store); renderAll(); autoCloudSave();
    } catch(err){ alert("Restore failed: " + err.message); }
    finally { e.target.value=""; }
  });

  $("exportCsv").addEventListener("click", ()=>{
    const acts = store.activities.map(a=>({id:a.id,date:a.date,title:a.title,details:a.details||"",durationMinutes:a.durationMinutes||0,tags:(a.tags||[]).join("|"),status:a.status,followUpId:a.followUpId||""}));
    const fus = store.followUps.map(f=>({id:f.id,createdAt:f.createdAt,dueDate:f.dueDate||"",title:f.title,notes:f.notes||"",tags:(f.tags||[]).join("|"),status:f.status}));
    const t = todayISO(); csvExport(`activities_${t}.csv`, acts); csvExport(`followups_${t}.csv`, fus);
  });

  $("range").addEventListener("change", renderAll);

  // ---------- Rendering ----------
  function renderAll(){
    const r = getCurrentRange();
    const acts = store.activities
      .filter(a=>within(a.date, r))
      .sort((a,b)=> (b.date.localeCompare(a.date) || (b.id||"").localeCompare(a.id||"")));
    $("kpiCount").textContent = acts.length;
    $("kpiDone").textContent = acts.filter(a=>a.status==="done").length;
    $("kpiFU").textContent = store.followUps.filter(f=>f.status!=="done").length;
    $("kpiHours").textContent = hours(acts.reduce((s,a)=>s+(a.durationMinutes||0),0));

    // list
    const list = $("list"); list.innerHTML="";
    if(!acts.length){ list.innerHTML="<div class='muted'>No entries for this range.</div>"; }
    acts.forEach(a=>{
      const item=document.createElement("div"); item.className="accordion-item";
      const header=document.createElement("button"); header.className="accordion-header"; header.setAttribute("aria-expanded","false");
      const left=document.createElement("div"); left.className="accordion-title";
      left.innerHTML = `<span class="caret">‚ñ∂</span><strong>${a.title}</strong> <span class="muted">(${fmtISO(a.date)})</span>`;
      const right=document.createElement("div");
      right.innerHTML = `<button class="edit" title="Edit hours">Edit</button> <button class="del" title="Delete">üóëÔ∏è</button>`;
      header.appendChild(left); header.appendChild(right);
      const content=document.createElement("div"); content.className="accordion-content";
      content.innerHTML = `
        ${a.details?`<div class="muted" style="margin:10px 0">${a.details}</div>`:""}
        <div class="row" style="margin-top:6px">
          ${a.durationMinutes?`<span class="tag">${hours(a.durationMinutes)} h</span>`:"<span class=\'tag\'>0 h</span>"}
          ${(a.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join("")}
        </div>
      `;
      header.addEventListener("click",(e)=>{
        // Avoid toggle when delete button is clicked
        if(e.target.closest(".del")) return;
        const open = item.classList.toggle("open");
        header.setAttribute("aria-expanded", String(open));
      });
      item.appendChild(header); item.appendChild(content);
      
      item.querySelector(".edit").addEventListener("click", ()=>{
        const curr = a.durationMinutes ? Math.round((a.durationMinutes/60)*100)/100 : 0;
        const val = prompt("Enter hours (e.g., 1.5):", curr);
        if (val===null) return;
        const h = parseFloat(val);
        if (isNaN(h) || h < 0) { alert("Please enter a non-negative number."); return; }
        const minutes = Math.round(h*60);
        store.activities = store.activities.map(x=> x.id===a.id ? { ...x, durationMinutes: minutes } : x);
        save(store); renderAll(); autoCloudSave();
      });
    
      item.querySelector(".del").addEventListener("click", ()=>{
        if(!confirm("Delete this activity?")) return;
        store.activities = store.activities.filter(x=>x.id!==a.id); save(store); renderAll(); autoCloudSave();
      });
      list.appendChild(item);
    });

    // Section-level toggle for Activities
    (function(){
      const btn = document.getElementById("toggleActivitiesSection");
      const section = document.getElementById("activitiesSectionContent");
      if (btn && section) {
        btn.addEventListener("click", ()=>{
          const hidden = section.classList.toggle("hidden");
          btn.textContent = hidden ? "Show section" : "Hide section";
        });
      }
    })();

    // Expand/collapse all controls
    $("actsExpandAll")?.addEventListener("click", ()=>{ [...list.querySelectorAll(".accordion-item")].forEach(i=>{ i.classList.add("open"); i.querySelector(".accordion-header").setAttribute("aria-expanded","true"); }); });
    $("actsCollapseAll")?.addEventListener("click", ()=>{ [...list.querySelectorAll(".accordion-item")].forEach(i=>{ i.classList.remove("open"); i.querySelector(".accordion-header").setAttribute("aria-expanded","false"); }); });
    

    // follow-ups
    const openRoot=$("fuOpen"), doneRoot=$("fuDone"); openRoot.innerHTML=""; doneRoot.innerHTML="";
    
const makeFU = (f) => {
  const wrap=document.createElement("div");
  wrap.className="item";
  // apply color class based on status
  const statusClass = f.status==="done" ? "fu-done" : (f.status==="in_progress" ? "fu-inprogress" : "fu-open");
  wrap.classList.add(statusClass);

  wrap.innerHTML = `
    <div class="fu-left">
      <div><strong class="fu-title">${f.title}</strong> <span class="muted fu-duetext">${f.dueDate?("Due "+fmtISO(f.dueDate)):"No due date"}</span></div>
      ${f.notes?`<div class="muted fu-notes">${f.notes}</div>`:""}
      <div class="fu-tags" style="margin-top:6px">${(f.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join("")}</div>

      <div class="fu-editbox hidden" style="margin-top:8px; border-top:1px dashed var(--border); padding-top:8px">
        <div class="row" style="gap:8px">
          <div style="flex:2 1 260px">
            <label>Title</label>
            <input class="e-title" value="${f.title.replace(/\"/g,'&quot;')}">
          </div>
          <div style="flex:1 1 160px">
            <label>Due date</label>
            <input class="e-due" type="date" value="${f.dueDate || ''}">
          </div>
          <div style="flex:1 1 200px">
            <label>Tags (comma separated)</label>
            <input class="e-tags" value="${(f.tags||[]).join(', ')}">
          </div>
          <div style="flex:1 1 100%">
            <label>Notes</label>
            <textarea class="e-notes" rows="3">${(f.notes||'').replace(/</g,'&lt;')}</textarea>
          </div>
          <div style="flex:1 1 100%; display:flex; gap:8px; justify-content:flex-end">
            <button class="save" type="button">Save</button>
            <button class="cancel" type="button">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    <div class="fu-right" style="display:flex; flex-direction:column; gap:8px; align-items:flex-end">
      <select class="status" style="min-width:140px">
        <option value="open" ${f.status==="open"?"selected":""}>Open</option>
        <option value="in_progress" ${f.status==="in_progress"?"selected":""}>In Progress</option>
        <option value="done" ${f.status==="done"?"selected":""}>Done</option>
      </select>
      <div style="display:flex; gap:8px">
        <button class="edit" title="Edit" type="button">Edit</button>
        <button class="rm" title="Remove" type="button">Delete</button>
      </div>
    </div>`;

  // Status change
  wrap.querySelector(".status").addEventListener("change", e=>{
    const newStatus=e.target.value;
    store.followUps = store.followUps.map(x=>x.id===f.id?{...x, status:newStatus}:x);
    save(store); renderAll(); autoCloudSave();
  });

  // Edit toggle
  const editBox = wrap.querySelector(".fu-editbox");
  wrap.querySelector(".edit").addEventListener("click", ()=>{
    editBox.classList.toggle("hidden");
  });

  // Save edits
  wrap.querySelector(".save").addEventListener("click", ()=>{
    const newTitle = wrap.querySelector(".e-title").value.trim();
    const newDue = wrap.querySelector(".e-due").value || undefined;
    const newTags = wrap.querySelector(".e-tags").value;
    const newNotes = wrap.querySelector(".e-notes").value;
    if (!newTitle){ alert("Title is required"); return; }
    store.followUps = store.followUps.map(x=> x.id===f.id ? { ...x, title:newTitle, dueDate:newDue, tags: parseTags(newTags), notes:newNotes } : x);
    save(store); renderAll(); autoCloudSave();
  });

  // Cancel edits
  wrap.querySelector(".cancel").addEventListener("click", ()=>{
    editBox.classList.add("hidden");
  });

  // Remove
  wrap.querySelector(".rm").addEventListener("click", ()=>{
    if(!confirm("Remove this follow-up?")) return;
    store.followUps = store.followUps.filter(x=>x.id!==f.id); save(store); renderAll(); autoCloudSave();
  });

  return wrap;
};

    const open = store.followUps.filter(f=>f.status!=="done");
    const done = store.followUps.filter(f=>f.status==="done");
    if(!open.length) openRoot.innerHTML = "<div class='muted'>No open follow-ups.</div>"; else open.forEach(f=>openRoot.appendChild(makeFU(f)));
    if(!done.length) doneRoot.innerHTML = "<div class='muted'>No completed follow-ups.</div>"; else done.forEach(f=>doneRoot.appendChild(makeFU(f)));

    // charts
    drawByDay(acts);
    drawByTag(acts);
    drawCumul(acts);
  }

  // ---------- Tiny chart helpers (no libraries) ----------
  function clearCanvas(c){ const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); }
  function drawAxes(ctx, w, h, padding){ ctx.strokeStyle="#cbd5e1"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(padding, h-padding); ctx.lineTo(w-padding, h-padding); ctx.moveTo(padding, padding); ctx.lineTo(padding, h-padding); ctx.stroke(); }
  function niceMax(v){ if(v<=1) return 1; const p=Math.pow(10, Math.floor(Math.log10(v))); return Math.ceil(v/p)*p; }

  function drawByDay(acts){
    const c=$("byDay"), ctx=c.getContext("2d"), w=c.width=c.clientWidth*2, h=c.height=c.height*2/2; // keep visual height
    clearCanvas(c);
    const padding=50;
    const map={}; acts.forEach(a=>{ map[a.date]=(map[a.date]||0)+(a.durationMinutes||0); });
    const entries=Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0]));
    const labels=entries.map(e=>e[0]); const values=entries.map(e=>hours(e[1]));
    const maxV=niceMax(Math.max(1, ...values, 1));
    drawAxes(ctx,w,h,padding);
    const plotW=w-2*padding, plotH=h-2*padding;
    const bw = labels.length? plotW/labels.length*0.6 : 0;
    labels.forEach((lab,i)=>{
      const x = padding + (plotW/Math.max(1,labels.length))*(i+0.5);
      const val = values[i]; const y = h - padding - (val/maxV)*plotH;
      ctx.fillStyle="#93c5fd"; ctx.fillRect(x-bw/2, y, bw, h-padding - y);
      ctx.fillStyle="#334155"; ctx.font="20px system-ui"; ctx.textAlign="center";
      if(labels.length<=12){ ctx.fillText(fmtISO(lab), x, h-padding+24); }
    });
    // y labels
    ctx.fillStyle="#334155"; ctx.textAlign="right";
    for(let t=0;t<=4;t++){ const v=maxV*t/4; const y=h-padding-(v/maxV)*plotH; ctx.fillText(String(v), padding-8, y+6); }
  }

  
  function drawByTag(acts){
    const c=$("byTag"), ctx=c.getContext("2d"), w=c.width=c.clientWidth*2, h=c.height=c.height*2/2;
    clearCanvas(c);
    const legend = document.getElementById("legendByTag"); if (legend) legend.innerHTML="";
    const map={}; acts.forEach(a=>(a.tags||[]).forEach(t=>{ map[t]=(map[t]||0)+(a.durationMinutes||0); }));
    const entries=Object.entries(map).sort((a,b)=>b[1]-a[1]); const labels=entries.map(e=>e[0]); const values=entries.map(e=>hours(e[1]));
    const total = values.reduce((s,v)=>s+v,0) || 1;
    const cx=w/2, cy=h/2, r=Math.min(w,h)/2 - 20;
    let start=0;
    labels.forEach((lab,i)=>{
      const frac = values[i]/total; const end = start + frac*2*Math.PI;
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle = `hsl(${(i*70)%360},70%,70%)`;
      ctx.arc(cx,cy, r, start, end); ctx.closePath(); ctx.fill();
      // Legend item
      if (legend) {
        const row = document.createElement("div");
        row.style.display = "flex"; row.style.alignItems = "center"; row.style.gap = "6px";
        const sw = document.createElement("span");
        sw.style.display="inline-block"; sw.style.width="12px"; sw.style.height="12px"; sw.style.borderRadius="3px";
        sw.style.background = `hsl(${(i*70)%360},70%,70%)`;
        const label = document.createElement("span");
        label.textContent = `${lab || "(untagged)"}`;
        row.appendChild(sw); row.appendChild(label);
        legend.appendChild(row);
      }
      start=end;
    });
    if (labels.length===0 && legend){
      const empty = document.createElement("div"); empty.className="muted"; empty.textContent="No tag data in this range."; legend.appendChild(empty);
    }
  }
  

  function drawCumul(acts){
    const c=$("cumul"), ctx=c.getContext("2d"), w=c.width=c.clientWidth*2, h=c.height=c.height*2/2;
    clearCanvas(c);
    const padding=50;
    const sorted=[...acts].sort((a,b)=>a.date.localeCompare(b.date));
    let cumAll=0; const labels=[], A=[], D=[];
    sorted.forEach(a=>{ cumAll++; labels.push(a.date); A.push(cumAll); D.push(cumAll); });
    const maxV=niceMax(Math.max(1, ...A, ...D, 1));
    drawAxes(ctx,w,h,padding);
    const plotW=w-2*padding, plotH=h-2*padding;
    function drawLine(vals,color){
      ctx.beginPath(); ctx.strokeStyle=color; ctx.lineWidth=3;
      vals.forEach((v,i)=>{
        const x = padding + (plotW/Math.max(1,labels.length-1))*(i);
        const y = h - padding - (v/maxV)*plotH;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }
    drawLine(A,"#1d4ed8"); drawLine(D,"#10b981");
    ctx.fillStyle="#334155"; ctx.textAlign="right";
    for(let t=0;t<=4;t++){ const v=maxV*t/4; const y=h-padding-(v/maxV)*plotH; ctx.fillText(String(v), padding-8, y+6); }
  }

  // ---------- Cloud sync via File System Access API (optional) ----------
  const CLOUD_KEY='cloudFileHandle';
  const cloud = { handle:null, connected:false, timer:null };
  const idb = {
    open(){ return new Promise((res,rej)=>{ const r=indexedDB.open('worklog-cloud-db',1); r.onupgradeneeded=()=>r.result.createObjectStore('handles'); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); },
    async set(k,v){ const db=await idb.open(); return new Promise((res,rej)=>{ const tx=db.transaction('handles','readwrite'); tx.objectStore('handles').put(v,k); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); },
    async get(k){ const db=await idb.open(); return new Promise((res,rej)=>{ const tx=db.transaction('handles','readonly'); const rq=tx.objectStore('handles').get(k); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error); }); },
    async del(k){ const db=await idb.open(); return new Promise((res,rej)=>{ const tx=db.transaction('handles','readwrite'); tx.objectStore('handles').delete(k); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); },
  };
  function updateCloudUI(){
    $("cloudStatus").textContent = "Cloud: " + (cloud.connected ? "Connected" : "Not connected");
    $("syncNow").classList.toggle("hidden", !cloud.connected);
    $("disconnectCloud").classList.toggle("hidden", !cloud.connected);
  }
  async function requestPerm(h,mode){ const p=await h.queryPermission({mode}); if(p==="granted") return true; if(p==="prompt"){ const r=await h.requestPermission({mode}); return r==="granted"; } return false; }
  async function cloudConnect(){
    if(!('showOpenFilePicker' in window)){ alert("Your browser does not allow file picking here. Try Edge/Chrome over HTTPS."); return; }
    try{
      const [h] = await window.showOpenFilePicker({ types:[{description:"JSON", accept:{"application/json":[".json"]}}], excludeAcceptAllOption:true, multiple:false });
      const ok = await requestPerm(h,'readwrite'); if(!ok){ alert("Permission denied."); return; }
      cloud.handle=h; await idb.set(CLOUD_KEY,h); cloud.connected=true; updateCloudUI();
      // Load from file (merge/replace)
      const f=await h.getFile(); if(f.size>0){ const text=await f.text(); try{ const obj=JSON.parse(text); if(obj.activities&&obj.followUps){ store=obj; save(store); } }catch{} }
      renderAll();
      autoCloudSave();
    }catch(e){ console.warn(e); }
  }
  async function cloudDisconnect(){ await idb.del(CLOUD_KEY); cloud.handle=null; cloud.connected=false; updateCloudUI(); }
  async function cloudSave(){
    if(!cloud.connected || !cloud.handle) return;
    const ok = await requestPerm(cloud.handle,'readwrite'); if(!ok) return;
    const w = await cloud.handle.createWritable(); await w.write(JSON.stringify(store,null,2)); await w.close();
  }
  function autoCloudSave(){ if(!cloud.connected) return; clearTimeout(cloud.timer); cloud.timer=setTimeout(cloudSave, 1000); }
  async function tryRestoreCloud(){
    try{ const h = await idb.get(CLOUD_KEY); if(!h) return; const ok=await requestPerm(h,'readwrite'); if(!ok) return; cloud.handle=h; cloud.connected=true; updateCloudUI(); }catch{}
  }

  $("connectCloud").addEventListener("click", cloudConnect);
  $("disconnectCloud").addEventListener("click", cloudDisconnect);
  $("syncNow").addEventListener("click", cloudSave);

  
  // ====== Summary export (CSV) ======
  function getActivitiesForCurrentRange(){
    const r = getCurrentRange();
    return store.activities.filter(a=>within(a.date, r));
  }
  function exportSummaryCsv(){
    const acts = getActivitiesForCurrentRange();
    // By day
    const mapD = {}; acts.forEach(a=>{ mapD[a.date]=(mapD[a.date]||0)+(a.durationMinutes||0); });
    const rowsDay = Object.entries(mapD).sort((a,b)=>a[0].localeCompare(b[0])).map(([date,mins])=>({date, hours: Math.round((mins/60)*100)/100 }));
    // By tag
    const mapT = {}; acts.forEach(a=>(a.tags||[]).forEach(t=>{ mapT[t]=(mapT[t]||0)+(a.durationMinutes||0); }));
    const rowsTag = Object.entries(mapT).sort((a,b)=>b[1]-a[1]).map(([tag,mins])=>({tag: tag||"(untagged)", hours: Math.round((mins/60)*100)/100 }));
    const today = todayISO();
    csvExport(`summary_by_day_${today}.csv`, rowsDay.length?rowsDay:[{date:"(none)", hours:0}]);
    csvExport(`summary_by_tag_${today}.csv`, rowsTag.length?rowsTag:[{tag:"(none)", hours:0}]);
  }
  document.getElementById("exportSummaryCsv")?.addEventListener("click", exportSummaryCsv);

  
  // ---- Quick Add Follow-up (no activity needed) ----
  const qfu = {
    title: document.getElementById("qfuTitle"),
    due: document.getElementById("qfuDue"),
    tags: document.getElementById("qfuTags"),
    status: document.getElementById("qfuStatus"),
    notes: document.getElementById("qfuNotes"),
    addBtn: document.getElementById("qfuAdd")
  };
  qfu.addBtn?.addEventListener("click", ()=>{
    const title = (qfu.title?.value || "").trim();
    if (!title){ alert("Please enter a follow-up title"); return; }
    const f = {
      id: "fu_"+Math.random().toString(36).slice(2,9)+"_"+Date.now().toString(36),
      createdAt: todayISO(),
      dueDate: qfu.due?.value || undefined,
      title,
      notes: (qfu.notes?.value || undefined),
      tags: parseTags(qfu.tags?.value || ""),
      status: qfu.status?.value || "open"
    };
    store.followUps = [f, ...store.followUps];
    save(store); renderAll(); autoCloudSave();
    // clear
    if(qfu.title) qfu.title.value="";
    if(qfu.due) qfu.due.value="";
    if(qfu.tags) qfu.tags.value="";
    if(qfu.status) qfu.status.value="open";
    if(qfu.notes) qfu.notes.value="";
  });

  
// ===== Printable / Exportable Summary =====
function getCurrentRangeActivitiesFollowups(){
  const r = getCurrentRange();
  const acts = store.activities.filter(a=>within(a.date, r)).sort((a,b)=> (a.date.localeCompare(b.date)));
  const fus = store.followUps.slice(); // include all follow-ups (or filter by status later if needed)
  return {r, acts, fus};
}
function toLocalTagString(tags){ return (tags||[]).join(", "); }

function makeSummaryHTML({r, acts, fus}){
  const fmt = d => fmtISO(d);
  const rangeTitle = `${fmt(r.start.toISOString().slice(0,10))} ‚Äî ${fmt(r.end.toISOString().slice(0,10))}`;

  // Aggregates
  const totalMins = acts.reduce((s,a)=>s+(a.durationMinutes||0),0);
  const totalHours = Math.round((totalMins/60)*100)/100;

  // Hours by Day
  const byDayMap = {};
  acts.forEach(a=>{ byDayMap[a.date] = (byDayMap[a.date]||0) + (a.durationMinutes||0); });
  const byDayArr = Object.entries(byDayMap)
    .map(([date,mins])=>({date, hours: Math.round((mins/60)*100)/100}))
    .sort((a,b)=> a.date.localeCompare(b.date));
  const byDayMax = byDayArr.reduce((m,x)=> Math.max(m, x.hours), 0) || 1;

  // Hours by Tag
  const byTagMap = {};
  acts.forEach(a => (a.tags||[]).forEach(t => { byTagMap[t] = (byTagMap[t]||0) + (a.durationMinutes||0); }));
  const byTagArr = Object.entries(byTagMap)
    .map(([tag,mins])=>({tag: tag||"(untagged)", hours: Math.round((mins/60)*100)/100}))
    .sort((a,b)=> b.hours - a.hours);
  const byTagSum = byTagArr.reduce((s,x)=> s+x.hours, 0) || 1;

  // Build conic-gradient pie stops (CSS-only)
  let stops = []; let acc = 0;
  byTagArr.forEach((x,i)=>{
    const pct = (x.hours / byTagSum) * 100;
    const start = acc; acc += pct;
    const hue = (i*70)%360;
    stops.push(`hsl(${hue},70%,70%) ${start.toFixed(2)}% ${acc.toFixed(2)}%`);
  });
  const pieStyle = stops.length ? `background: conic-gradient(${stops.join(", ")});` : "background:#e2e8f0;";

  // Table rows
  function rowsActivities(){
    if(!acts.length) return '<tr><td colspan="4" class="ps-muted">No activities in this range.</td></tr>';
    return acts.map(a=>`
      <tr>
        <td>${fmt(a.date)}</td>
        <td>${a.title}</td>
        <td>${a.durationMinutes?Math.round((a.durationMinutes/60)*100)/100:0}</td>
        <td>${(a.tags||[]).join(", ")}</td>
      </tr>`).join("");
  }
  function rowsFollowups(list){
    if(!list.length) return '<tr><td colspan="5" class="ps-muted">None</td></tr>';
    return list.map(f=>`
      <tr>
        <td><span class="ps-status-dot ${f.status}"></span>${f.title}</td>
        <td>${f.dueDate?fmt(f.dueDate):""}</td>
        <td>${(f.tags||[]).join(", ")}</td>
        <td>${(f.notes||"").replace(/</g,"&lt;")}</td>
        <td class="ps-status ${f.status}">${f.status.replace("_"," ")}</td>
      </tr>`).join("");
  }
  const fuOpen = fus.filter(f=>f.status!=="done");
  const fuDone = fus.filter(f=>f.status==="done");

  // Legend for by-tag
  const tagLegend = byTagArr.map((x,i)=>{
    const hue=(i*70)%360;
    return `<div class="ps-legend-row"><span class="ps-sw" style="background:hsl(${hue},70%,70%)"></span><span>${x.tag}</span></div>`;
  }).join("") || '<div class="ps-muted">No tag data in this range.</div>';

  // NOTE: Styles are *scoped* under .print-root so they don't leak into the dashboard when used in overlay.
  return `<!doctype html>
  <html><head><meta charset="utf-8"><title>Worklog Summary ${rangeTitle}</title></head>
  <body>
    <div class="print-root">
      <style>
        .print-root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#0f172a;background:#fff;margin:24px}
        .print-root .ps-muted{color:#475569}
        .print-root .ps-pill{display:inline-block;padding:4px 10px;border:1px solid #e2e8f0;border-radius:999px;background:#f8fafc}
        .print-root header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
        .print-root .ps-title{font-size:26px;font-weight:800}
        .print-root .ps-kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:12px 0}
        .print-root .ps-kpi{border:1px solid #e2e8f0;border-radius:14px;padding:12px;background:#fff;display:flex;gap:10px;align-items:center}
        .print-root .ps-kpi .ps-icon{font-size:22px}
        .print-root .ps-kpi .ps-val{font-weight:800;font-size:26px}
        .print-root .ps-kpi.hours{background:#fff7ed}
        .print-root .ps-kpi.acts{background:#f8fafc}
        .print-root .ps-kpi.open{background:#fffbeb}
        .print-root .ps-kpi.done{background:#ecfdf5}
        .print-root .ps-grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin:12px 0}
        .print-root .ps-card{border:1px solid #e2e8f0;border-radius:14px;padding:12px;background:#fff}
        .print-root table{border-collapse:collapse;width:100%;margin:10px 0 24px 0}
        .print-root th,.print-root td{border:1px solid #e2e8f0;padding:8px;vertical-align:top}
        .print-root th{background:#f8fafc;text-align:left}
        .print-root tr:nth-child(even){background:#fafafa}
        .print-root .ps-bar{height:14px;border-radius:999px;background:#dbeafe}
        .print-root .ps-bar > span{display:block;height:100%;border-radius:999px;background:#60a5fa}
        .print-root .ps-pie{width:220px;height:220px;border-radius:50%;${"${pieStyle}"}margin:auto}
        .print-root .ps-legend{display:flex;flex-direction:column;gap:6px;margin-top:8px}
        .print-root .ps-legend-row{display:flex;gap:8px;align-items:center}
        .print-root .ps-legend-row .ps-sw{width:12px;height:12px;border-radius:3px;background:#e2e8f0;display:inline-block}
        .print-root .ps-status-dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:middle}
        .print-root .ps-status-dot.open{background:#f59e0b}
        .print-root .ps-status-dot.in_progress{background:#3b82f6}
        .print-root .ps-status-dot.done{background:#10b981}
        .print-root td.ps-status.open{color:#b45309;font-weight:600}
        .print-root td.ps-status.in_progress{color:#1d4ed8;font-weight:600}
        .print-root td.ps-status.done{color:#059669;font-weight:600}
        @media print{
          .print-root .no-print{display:none}
          .print-root .ps-kpis{grid-template-columns:repeat(4,1fr)}
          .print-root .ps-grid2{grid-template-columns:1fr 1fr}
        }
      </style>

      <header>
        <div>
          <div class="ps-title">Worklog Summary</div>
          <div class="ps-pill ps-muted">Range: ${rangeTitle}</div>
        </div>
        <div class="no-print"><button onclick="window.print()">Print</button></div>
      </header>

      <section class="ps-kpis">
        <div class="ps-kpi hours"><div class="ps-icon">‚è±</div><div><div class="ps-muted">Total Hours</div><div class="ps-val">${totalHours}</div></div></div>
        <div class="ps-kpi acts"><div class="ps-icon">üìã</div><div><div class="ps-muted">Activities</div><div class="ps-val">${acts.length}</div></div></div>
        <div class="ps-kpi open"><div class="ps-icon">üö®</div><div><div class="ps-muted">Open Follow-ups</div><div class="ps-val">${fuOpen.length}</div></div></div>
        <div class="ps-kpi done"><div class="ps-icon">‚úÖ</div><div><div class="ps-muted">Completed</div><div class="ps-val">${fuDone.length}</div></div></div>
      </section>

      <section class="ps-grid2">
        <div class="ps-card">
          <div class="ps-muted" style="margin-bottom:8px">Hours by Day</div>
          ${byDayArr.length ? byDayArr.map(x=>`
            <div style="display:flex; align-items:center; gap:10px; margin:6px 0">
              <div style="width:90px" class="ps-muted">${fmt(x.date)}</div>
              <div class="ps-bar" style="flex:1"><span style="width:${"${Math.min(100, (x.hours/byDayMax)*100)}"}%"></span></div>
              <div style="width:54px;text-align:right" class="ps-muted">${x.hours}</div>
            </div>`).join("") : '<div class="ps-muted">No data</div>'}
        </div>

        <div class="ps-card" style="text-align:center">
          <div class="ps-muted" style="margin-bottom:8px">Hours by Tag</div>
          <div class="ps-pie"></div>
          <div class="ps-legend">${tagLegend}</div>
        </div>
      </section>

      <h2>Activities</h2>
      <table>
        <thead><tr><th>Date</th><th>Title</th><th>Hours</th><th>Tags</th></tr></thead>
        <tbody>${rowsActivities()}</tbody>
      </table>

      <h2>Follow-ups (Open)</h2>
      <table>
        <thead><tr><th>Title</th><th>Due</th><th>Tags</th><th>Notes</th><th>Status</th></tr></thead>
        <tbody>${rowsFollowups(fuOpen)}</tbody>
      </table>

      <h2>Follow-ups (Completed)</h2>
      <table>
        <thead><tr><th>Title</th><th>Due</th><th>Tags</th><th>Notes</th><th>Status</th></tr></thead>
        <tbody>${rowsFollowups(fuDone)}</tbody>
      </table>
    </div>
  </body></html>`;
}
function openPrintableSummary(){
  // Try to open a new window immediately (user gesture)
  let w = null;
  try { w = window.open("", "_blank", "noopener,noreferrer,width=1200,height=800"); } catch {}
  const data = getCurrentRangeActivitiesFollowups();
  const html = makeSummaryHTML(data);
  // If window opened, try writing to it; if any step fails, fall back
  if (w && !w.closed) {
    try {
      w.document.open();
      w.document.write(html);
      w.document.close();
      return;
    } catch (e) {
      // fall through to overlay
    }
  }
  // Fallback: show an in-page overlay that's printable
  const overlay = document.getElementById("printOverlay");
  const content = document.getElementById("printContent");
  if (overlay && content) {
    const m = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
    content.innerHTML = m ? m[1] : html;
    overlay.classList.remove("hidden");
  } else {
    alert("Unable to open print view. Please try again or download CSV.");
  }
}
function exportSummaryCsv(){
  const {r, acts, fus} = getCurrentRangeActivitiesFollowups();
  // Activities CSV
  const actsRows = acts.map(a=>({date:a.date,title:a.title,hours:Math.round((a.durationMinutes||0)/60*100)/100,tags:(a.tags||[]).join("|")}));
  csvExport(`summary_activities_${todayISO()}.csv`, actsRows.length?actsRows:[{date:"",title:"(none)",hours:0,tags:""}]);
  // Follow-ups CSV
  const fuRows = fus.map(f=>({title:f.title,dueDate:f.dueDate||"",tags:(f.tags||[]).join("|"),notes:(f.notes||"").replace(/\\n/g," "),status:f.status}));
  csvExport(`summary_followups_${todayISO()}.csv`, fuRows.length?fuRows:[{title:"(none)",dueDate:"",tags:"",notes:"",status:""}]);
}
document.getElementById("openPrintableSummary")?.addEventListener("click", openPrintableSummary);
document.getElementById("exportSummaryCsv")?.addEventListener("click", exportSummaryCsv);


// Overlay controls
document.getElementById("printOverlayClose")?.addEventListener("click", ()=>{
  document.getElementById("printOverlay")?.classList.add("hidden");
});
document.getElementById("printOverlayPrint")?.addEventListener("click", ()=>{
  window.print();
});

// ---------- Init ----------
  (async function(){
    await tryRestoreCloud();
    renderAll();
  })();
  </script>

<div id="printOverlay" class="print-overlay hidden">
  <div class="print-toolbar no-print">
    <button id="printOverlayPrint" type="button">Print</button>
    <button id="printOverlayClose" type="button">Close</button>
  </div>
  <div id="printContent"></div>
</div>

</body>
</html>
